_format_version: "3.0"
_transform: true

services:
  # AuthService
  - name: auth-service
    url: http://host.docker.internal:3001
    routes:
      # Route công khai cho đăng nhập và đăng ký
      - name: auth-public-route
        paths:
          - /api/auth/login
          - /api/auth/register
          - /api/auth/admin/login
        strip_path: false
        methods: [POST, OPTIONS]
        plugins:
          - name: rate-limiting
            config:
              minute: 10
              limit_by: ip
      # Route cần xác thực để lấy thông tin người dùng
      - name: auth-protected-route
        paths:
          - /api/auth/profile
          - /api/auth/user
        strip_path: false
        methods: [GET, PUT , OPTIONS]
        plugins:
          - name: jwt 
          - name: rate-limiting
            config:
              minute: 100
              limit_by: consumer
    plugins:
      - name: cors
        config:
          origins: ['*']
          methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
          headers: ['Accept', 'Accept-Version', 'Content-Length', 'Content-MD5', 'Content-Type', 'Date', 'Authorization']
          exposed_headers: ['X-Auth-Token']
          credentials: true
          max_age: 3600

  # DoctorService
  - name: doctor-service
    url: http://host.docker.internal:3002
    routes:
      # Route công khai để lấy thông tin bác sĩ
      - name: doctor-public-route
        paths:
          - /api/doctors
        strip_path: false
        methods: [GET, OPTIONS]
      # Route cần xác thực để tạo, cập nhật, xóa bác sĩ
      - name: doctor-protected-route
        paths:
          - /api/doctors
          - /api/schedules
        strip_path: false
        methods: [GET,POST, PUT, DELETE, OPTIONS]
        plugins:
          - name: jwt
    plugins:
      - name: cors
        config:
          origins: ['*']
          methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
          headers: ['Accept', 'Accept-Version', 'Content-Length', 'Content-MD5', 'Content-Type', 'Date', 'Authorization']
          exposed_headers: ['X-Auth-Token']
          credentials: true
          max_age: 3600
      - name: rate-limiting
        config:
          minute: 200
          limit_by: consumer
          
  # AppointmentService
  - name: appointment-service
    url: http://host.docker.internal:3003
    routes:
      - name: appointment-route
        paths:
          - /api/appointments
        strip_path: false
    plugins:
      - name: jwt 
      - name: cors
        config:
          origins: ['*']
          methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH']
          headers: ['Accept', 'Accept-Version', 'Content-Length', 'Content-MD5', 'Content-Type', 'Date', 'Authorization']
          exposed_headers: ['X-Auth-Token']
          credentials: true
          max_age: 3600
      - name: rate-limiting
        config:
          minute: 100
          limit_by: consumer

  # PaymentService
  - name: payment-service
    url: http://host.docker.internal:3004
    routes:
      - name: payment-route
        paths:
          - /api/invoices
          - /api/bank-accounts
        strip_path: false
    plugins:
      - name: jwt 
      - name: cors
        config:
          origins: ['*']
          methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
          headers: ['Accept', 'Accept-Version', 'Content-Length', 'Content-MD5', 'Content-Type', 'Date', 'Authorization']
          exposed_headers: ['X-Auth-Token']
          credentials: true
          max_age: 3600
      - name: rate-limiting
        config:
          minute: 50
          limit_by: consumer

consumers:
  - username: web-user
  - username: web-admin

jwt_secrets:
  - consumer: web-user
    key: web-user
    algorithm: HS256
    secret: haha
  - consumer: web-admin
    key: web-admin
    algorithm: HS256
    secret: haha